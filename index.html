<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>API Proxy for Figma Plugin</title>
</head>
<body>
  <p id="status">Waiting for requests from Figma plugin…</p>
<script>
  // Tell the plugin we're up and running
  parent.postMessage({ pluginMessage: { type: 'proxy-ready' } }, '*');

  // Listen for requests from the plugin
  window.onmessage = async (event) => {
    const msg = event.data.pluginMessage;
    if (!msg) return;

    const statusEl = document.getElementById('status');
    const requestId = msg.requestId;

    try {
      switch (msg.type) {
        case 'fal-submit-request':
          await handleFalSubmitRequest(msg, statusEl, requestId);
          break;
        
        case 'fal-check-status':
          await handleFalCheckStatus(msg, statusEl, requestId);
          break;
        
        case 'fal-get-result':
          await handleFalGetResult(msg, statusEl, requestId);
          break;
        
        case 'vectorize-image':
          await handleVectorizeImage(msg, statusEl, requestId);
          break;
        
        default:
          throw new Error(`Unknown request type: ${msg.type}`);
      }
    } catch (err) {
      statusEl.textContent = 'Error: ' + err.message;
      parent.postMessage({
        pluginMessage: {
          type: 'error',
          requestId: requestId,
          error: err.message
        }
      }, '*');
    }
  };

  // Generic fetch function with proper error handling
  async function makeRequest(url, options = {}) {
    const response = await fetch(url, {
      ...options,
      mode: 'cors',
      credentials: 'omit'
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
    }

    return response.json();
  }

  // Handle FAL API submit request
  async function handleFalSubmitRequest(msg, statusEl, requestId) {
    statusEl.textContent = 'Submitting image generation request…';
    
    const result = await makeRequest(msg.url, {
      method: 'POST',
      headers: {
        'Authorization': `Key ${msg.apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(msg.body)
    });
    
    parent.postMessage({
      pluginMessage: {
        type: 'fal-submit-success',
        requestId: requestId,
        result: result
      }
    }, '*');
    
    statusEl.textContent = 'Request submitted successfully';
  }

  // Handle FAL API status check
  async function handleFalCheckStatus(msg, statusEl, requestId) {
    statusEl.textContent = 'Checking generation status…';
    
    const result = await makeRequest(msg.url, {
      method: 'GET',
      headers: {
        'Authorization': `Key ${msg.apiKey}`,
      }
    });
    
    parent.postMessage({
      pluginMessage: {
        type: 'fal-status-success',
        requestId: requestId,
        result: result
      }
    }, '*');
    
    statusEl.textContent = 'Status checked successfully';
  }

  // Handle FAL API get result
  async function handleFalGetResult(msg, statusEl, requestId) {
    statusEl.textContent = 'Fetching generation result…';
    
    const result = await makeRequest(msg.url, {
      method: 'GET',
      headers: {
        'Authorization': `Key ${msg.apiKey}`,
      }
    });
    
    parent.postMessage({
      pluginMessage: {
        type: 'fal-result-success',
        requestId: requestId,
        result: result
      }
    }, '*');
    
    statusEl.textContent = 'Result fetched successfully';
  }

  // Handle Recraft vectorization
  async function handleVectorizeImage(msg, statusEl, requestId) {
    statusEl.textContent = 'Vectorizing image…';

    // Decode base64 → binary
    const b64 = msg.imageDataBase64;
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) {
      arr[i] = bin.charCodeAt(i);
    }
    
    // Turn into a Blob and build FormData
    const blob = new Blob([arr], { type: 'image/png' });
    const form = new FormData();
    form.append('file', blob, msg.filename || 'image.png');
    form.append('response_format', 'url');
    if (msg.style) {
      form.append('style', msg.style);
    }

    // Call Recraft API
    const response = await fetch(
      'https://external.api.recraft.ai/v1/images/vectorize',
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${msg.apiKey}`
        },
        body: form,
        mode: 'cors',
        credentials: 'omit'
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Recraft API failed: ${response.status} ${response.statusText} - ${errorText}`);
    }

    const json = await response.json();

    // Send the SVG URL back to the plugin
    parent.postMessage({
      pluginMessage: {
        type: 'vectorize-success',
        requestId: requestId,
        result: { url: json.image.url }
      }
    }, '*');
    
    statusEl.textContent = 'Vectorization completed!';
  }
</script>
</body>
</html>
